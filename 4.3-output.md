# output
在建置過程中，Next.js 將自動追蹤每個頁面及其依賴項，以確定部署應用程式的生產版本所需的所有檔案。

此功能有助於大幅減少部署規模。   
以前，使用 Docker 進行部署時，您需要安裝套件相依性中的所有檔案才能在下次啟動時執行。
從 Next.js 12 開始，您可以利用 `.next/` directory 中的`輸出檔案`追蹤來僅包含必要的檔案。

此外，這消除了對已棄用的 serverless target 的需要，因為無伺服器目標可能會導致各種問題，並且還會產生不必要的重複。

## How it Works
在下一次建置期間，Next.js 將使用 `@vercel/nft` 靜態分析 import、require 和 fs 使用情況，以確定頁面可能載入的所有檔案。

Next.js 的生產伺服器還可以在 `.next/next-server.js.nft.json` 中追蹤其所需的檔案和輸出，這些檔案可以在生產中使用。

要利用(leverage)發送到 `.next` output directory 的 `.nft.json` 文件，您可以讀取每個追蹤中與 .nft.json 文件相關的文件列表，然後將它們複製到您的部署位置。

## Automatically Copying Traced Files
Next.js 可以自動建立一個獨立(standalone)資料夾，僅複製生產部署(only the necessary files for a production deployment)所需的文件，包括 node_modules 中的選擇檔。

要利用此自動複製功能，您可以在 next.config.js 中啟用它：

```js
module.exports = {
  output: 'standalone',
}
```
這將在 `.next/standalone` 中建立一個資料夾，然後可以單獨部署該資料夾，而無需安裝 `node_modules`。

此外，還會輸出一個最小的 server.js 文件，可用來取代下次啟動。   
預設情況下，這個最小的伺服器不會複製 public 或 `.next/static` 資料夾，因為理想情況下這些資料夾應該由 CDN 處理，儘管可以手動將這些資料夾複製到 standalone/public 和 standalone/.next/ static 資料夾，然後server.js 檔案將自動提供這些服務。

**Good to know:**
- 如果您的專案需要監聽特定 port 或 hostname，您可以在執行 server.js 之前定義 PORT 或 HOSTNAME 環境變數。例如，執行 `PORT=8080` HOSTNAME=0.0.0.0 node server.js` 以在 `http://0.0.0.0:8080` 上啟動伺服器。
- If your project uses `Image` Optimization with the default `loader`，則必須安裝 Sharp 作為依賴項：

---

## Caveats 注意事項
- 在 monorepo(單一倉庫) 設定中進行追蹤時，預設情況下使用專案目錄進行追蹤。   
對於下一個建置 packages/web-app，packages/web-app 將是追蹤根目錄，並且不會包含該資料夾以外的任何檔案。若要包含此資料夾以外的文件，您可以在 next.config.js 中設定 experimental.outputFileTracingRoot。
- 在某些情況下，Next.js 可能無法包含所需的文件，或者可能錯誤地包含未使用的文件。在這些情況下，您可以在 next.config.js 中分別利用 experimental.outputFileTracingExcludes 和experimental.outputFileTracingIncludes。每個配置都接受一個帶有 minimatch glob 的對象，作為匹配特定頁面的鍵，以及一個帶有相對於項目根的 glob 的數組值，以便在跟踪中包含或排除。
- 目前，Next.js 不會對發出的 `.nft.json` 檔案執行任何操作。這些檔案必須由您的部署平台（例如 Vercel）讀取，才能建立最小部署。在未來的版本中，計劃使用一個新命令來利用這些 `.nft.json` 檔案。

---

## Experimental(實驗性的) turbotrace
追蹤依賴關係可能會很慢，因為它需要非常複雜的計算和分析。我們在 Rust 中創建了 Turbotrace，作為 JavaScript 實現的更快、更聰明的替代方案。

要啟用它，您可以將以下配置新增至 next.config.js：

---

# pageExtensions

預設情況下，Next.js 接受具有以下副檔名的檔案：.tsx、.ts、.jsx、.js。可以修改它以允許其他副檔名，例如 markdown（.md、.mdx）。

---

# poweredByHeader
預設情況下，Next.js 將新增 `x-powered-by` 標頭。若要選擇退出，請開啟 next.config.js 並停用poweredByHeader 設定：

---

# productionBrowserSourceMaps
Source Maps are enabled by default during development。在 production builds 期間，它們被停用以防止您在客戶端洩漏原始程式碼，除非您特別選擇使用組態標誌。

Next.js 提供了一個配置標誌，you can use to enable `browser source map generation` during the `production` build:

```js
module.exports = {
  productionBrowserSourceMaps: true,
}
```
當啟用 productionBrowserSourceMaps 選項時，source maps 將輸出到與 JavaScript 檔案相同的目錄中。 Next.js 將根據請求自動提供這些檔案。
- Adding source maps can increase(增加) `next build` time
- Increases(增加) memory usage during `next build`

---




















